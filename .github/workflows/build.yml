name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v1.0.1). Leave empty to use current branch.'
        required: false
        type: string

permissions:
  contents: write

jobs:
  # Generate changelog from git commits
  generate-changelog:
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.tag || github.ref }}

      - name: Debug Git state
        run: |
          echo "=== Git Debug Information ==="
          echo "Current branch: $(git branch --show-current)"
          echo "Current commit: $(git rev-parse HEAD)"
          echo "Available tags:"
          git tag -l | head -10
          echo "Package.json version: $(node -p "require('./package.json').version")"
          echo "Remote URL: $(git remote get-url origin)"

      - name: Determine tag
        id: tag
        run: |
          if [[ -n "${{ github.event.inputs.tag }}" ]]; then
            TAG="${{ github.event.inputs.tag }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
          else
            TAG="v$(node -p "require('./package.json').version")"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Tag: $TAG"

      - name: Create and push tag if not exists
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          
          # Check if tag already exists locally
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists locally"
          else
            echo "Creating new tag: $TAG"
            git tag "$TAG"
          fi
          
          # Check if tag exists on remote
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG$"; then
            echo "Tag $TAG already exists on remote"
          else
            echo "Pushing tag $TAG to remote"
            git push origin "$TAG"
          fi

      - name: Get version
        id: version
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Verify tag exists
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          if ! git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Error: Tag $TAG does not exist after creation attempt"
            echo "Available tags:"
            git tag -l | head -10
            exit 1
          fi
          echo "‚úÖ Tag $TAG verified successfully"

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag with improved error handling
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found, using all commits"
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "Generating changelog from $PREVIOUS_TAG to HEAD"
            COMMITS=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Create changelog with categories
          CHANGELOG="## üéâ What's New in v${{ steps.version.outputs.version }}

          ### üìù Changes
          $COMMITS

          ### üì¶ Installation
          Download the appropriate file for your platform:
          - **Windows**: \`.msi\` installer
          - **macOS (Apple Silicon)**: \`.dmg\` for M1/M2/M3 Macs
          - **macOS (Intel)**: \`.dmg\` for Intel Macs
          - **Linux**: \`.deb\` or \`.AppImage\`

          ### üîó Links
          - [Full Changelog](https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG...v${{ steps.version.outputs.version }})
          - [Documentation](https://github.com/${{ github.repository }}#readme)"

          # Save to output (escape newlines)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  build:
    needs: generate-changelog
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
            name: macOS-Apple-Silicon
            rust-target: aarch64-apple-darwin
          - platform: macos-latest
            target: x86_64-apple-darwin
            name: macOS-Intel
            rust-target: x86_64-apple-darwin
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            name: Windows
            rust-target: x86_64-pc-windows-msvc
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            name: Linux
            rust-target: x86_64-unknown-linux-gnu

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.generate-changelog.outputs.tag }}

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            pkg-config \
            build-essential \
            curl \
            wget \
            file

      - name: Rust setup
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust-target }}

      - name: Install Rust target
        run: rustup target add ${{ matrix.rust-target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: --verbose --target ${{ matrix.target }}

      - name: List build artifacts for debugging
        run: |
          echo "=== Build Artifacts Debug ==="
          echo "Target: ${{ matrix.target }}"
          echo "Platform: ${{ matrix.platform }}"
          find src-tauri/target/${{ matrix.target }}/release -name "*.dmg" -o -name "*.app" -o -name "*.deb" -o -name "*.AppImage" -o -name "*.exe" -o -name "*.msi" 2>/dev/null || echo "No artifacts found in expected location"
          
          # Also check bundle directory structure
          if [ -d "src-tauri/target/${{ matrix.target }}/release/bundle" ]; then
            echo "Bundle directory contents:"
            ls -la src-tauri/target/${{ matrix.target }}/release/bundle/
          fi

      - name: Prepare release files
        id: prepare-files
        run: |
          echo "=== Preparing Release Files ==="
          RELEASE_FILES=""
          
          # Check for different file types based on platform
          if [[ "${{ matrix.platform }}" == "macos-latest" ]]; then
            # macOS files
            if ls src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg 1> /dev/null 2>&1; then
              RELEASE_FILES="$RELEASE_FILES$(find src-tauri/target/${{ matrix.target }}/release/bundle/dmg -name "*.dmg" | tr '\n' ' ')"
            fi
            if ls src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app 1> /dev/null 2>&1; then
              RELEASE_FILES="$RELEASE_FILES$(find src-tauri/target/${{ matrix.target }}/release/bundle/macos -name "*.app" | tr '\n' ' ')"
            fi
          elif [[ "${{ matrix.platform }}" == "windows-latest" ]]; then
            # Windows files
            if ls src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi 1> /dev/null 2>&1; then
              RELEASE_FILES="$RELEASE_FILES$(find src-tauri/target/${{ matrix.target }}/release/bundle/msi -name "*.msi" | tr '\n' ' ')"
            fi
            if [[ -f "src-tauri/target/${{ matrix.target }}/release/ATM.exe" ]]; then
              RELEASE_FILES="$RELEASE_FILES src-tauri/target/${{ matrix.target }}/release/ATM.exe "
            fi
          elif [[ "${{ matrix.platform }}" == "ubuntu-22.04" ]]; then
            # Linux files
            if ls src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb 1> /dev/null 2>&1; then
              RELEASE_FILES="$RELEASE_FILES$(find src-tauri/target/${{ matrix.target }}/release/bundle/deb -name "*.deb" | tr '\n' ' ')"
            fi
            if ls src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage 1> /dev/null 2>&1; then
              RELEASE_FILES="$RELEASE_FILES$(find src-tauri/target/${{ matrix.target }}/release/bundle/appimage -name "*.AppImage" | tr '\n' ' ')"
            fi
          fi
          
          echo "Files to upload: $RELEASE_FILES"
          echo "release-files=$RELEASE_FILES" >> $GITHUB_OUTPUT

      - name: Upload artifacts to Release
        if: steps.prepare-files.outputs.release-files != ''
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.generate-changelog.outputs.tag }}
          name: 'ATM v${{ needs.generate-changelog.outputs.version }}'
          body: ${{ needs.generate-changelog.outputs.changelog }}
          draft: false
          prerelease: false
          files: ${{ steps.prepare-files.outputs.release-files }}

  # Notify on Telegram when all builds complete
  notify-telegram:
    needs: [generate-changelog, build]
    runs-on: ubuntu-latest
    if: always() && needs.build.result == 'success'
    steps:
      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          VERSION: ${{ needs.generate-changelog.outputs.version }}
          REPO_NAME: ${{ github.repository }}
        run: |
          # Escape MarkdownV2 special characters
          escape_markdown() {
            echo "$1" | sed -e 's/\\/\\\\/g' \
                            -e 's/_/\\_/g' \
                            -e 's/\*/\\*/g' \
                            -e 's/\[/\\[/g' \
                            -e 's/\]/\\]/g' \
                            -e 's/(/\\(/g' \
                            -e 's/)/\\)/g' \
                            -e 's/~/\\~/g' \
                            -e 's/`/\\`/g' \
                            -e 's/>/\\>/g' \
                            -e 's/#/\\#/g' \
                            -e 's/+/\\+/g' \
                            -e 's/-/\\-/g' \
                            -e 's/=/\\=/g' \
                            -e 's/|/\\|/g' \
                            -e 's/{/\\{/g' \
                            -e 's/}/\\}/g' \
                            -e 's/\./\\./g' \
                            -e 's/!/\\!/g'
          }

          VERSION_ESCAPED=$(escape_markdown "$VERSION")
          REPO_ESCAPED=$(escape_markdown "$REPO_NAME")

          MESSAGE="
          üéâ *New Release Published*

          üì¶ *ATM v${VERSION_ESCAPED}*
          üè∑Ô∏è Repository: \`${REPO_ESCAPED}\`

          ‚úÖ All platform builds completed successfully:
          ‚Ä¢ Windows \(x64\) \- MSI & EXE
          ‚Ä¢ macOS \(Apple Silicon\) \- DMG
          ‚Ä¢ macOS \(Intel\) \- DMG  
          ‚Ä¢ Linux \(x64\) \- DEB & AppImage

          üîó [Download Release](https://github.com/${REPO_NAME}/releases/tag/${VERSION_ESCAPED})

          üéä *Release is now live and ready for download\!*
          "

          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            --data-urlencode text="$MESSAGE" \
            -d parse_mode="MarkdownV2" || echo "Failed to send Telegram notification (non-critical)"
